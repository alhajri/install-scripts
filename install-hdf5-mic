#!/bin/bash

set -e

version=$1
zlib_version=1.2.8
install_prefix=$HOME/opt

# ------------------------------------------------------------------------------
# Download and install zlib since local version won't suffice
if [[ ! -e zlib-${zlib_version}.tar.gz ]]; then
    wget http://zlib.net/zlib-${zlib_version}.tar.gz
fi

rm -rf zlib-${zlib_version}
tar xvf zlib-${zlib_version}.tar.gz
cd zlib-${zlib_version}
CC=icc CXX=icpc CFLAGS="-mmic -O3 -fopenmp" CXXFLAGS="-mmic -O3 -fopenmp" \
    ./configure --static --prefix=${install_prefix}/zlib/${zlib_version}-mic
make
make install
cd ..

# ------------------------------------------------------------------------------
# Download tarball
if [[ ! -e hdf5-${version}.tar.bz2 ]]; then
    wget http://www.hdfgroup.org/ftp/HDF5/current/src/hdf5-${version}.tar.bz2
fi

rm -rf hdf5-${version}
tar xvf hdf5-${version}.tar.bz2
cd hdf5-${version}

# There are a few files that are autogenerated during the build process by
# running an executable -- this won't work since the executable will be for the
# MIC. Thus, first we ./configure for the host and get the files we need and
# then copy them later
CC=icc FC=ifort ./configure --enable-fortran --enable-fortran2003
cd src
make H5Tinit.c
make H5lib_settings.c
cp H5Tinit.c H5lib_settings.c ../../
cd ../fortran/src
make H5fortran_types.f90
cp H5fortran_types.f90 H5f90i_gen.h ../../../
cd ../..

# Now clear out the original build and copy the files that were generated earlier
make distclean
cp ../H5lib_settings.c ../H5Tinit.c src/
cp ../H5fortran_types.f90 ../H5f90i_gen.h fortran/src/

# This hack allows configure to continue even when it wants to error out because
# resulting executables can't be run
sed -i.bak -e '428 d' configure

CC=icc FC=ifort CFLAGS="-mmic -O3 -fopenmp" FCFLAGS="-mmic -O3 -fopenmp" \
    ./configure --prefix=${install_prefix}/hdf5/${version}-mic \
    --host=x86_64-k1om-linux --enable-shared=no \
    --enable-fortran --enable-fortran2003 \
    --with-zlib=${install_prefix}/zlib/${zlib_version}

# Touch auto-generated files so make doesn't attempt to rebuild them
cd src
make -t H5lib_settings.c
make -t H5Tinit.c
cd ../fortran/src
make -t H5fortran_types.f90
make -t H5f90i_gen.h
cd ../../

make
make install
cd ..
